<!DOCTYPE html>
<html>
    <head>
        <script type="module">

            var inputfield = document.getElementById("inputtext")
            var targetdiv = document.getElementById("result")

            var taskidtowaitfor
            var intervalid

            async function waiter() {
                var statusresponse = await fetch("/api/v1/tasks/status/" + taskidtowaitfor)
                var statusresult = await statusresponse.json()
                if (statusresult.status === "completed") {
                    var resultresponse = await fetch("/api/v1/tasks/result/" + taskidtowaitfor)
                    var json = await resultresponse.json()
                    var translatedtexts = json.result.texts
                    targetdiv.innerHTML = translatedtexts.map(el => `<span title="${el.language || ""}">${el.text}</span>`).join("<br/>")
                    await fetch("/api/v1/tasks/remove/" + taskidtowaitfor, { method: 'DELETE' })
                    clearInterval(intervalid)
                    intervalid = undefined
                } else {
                    targetdiv.innerText = `Waiting for result of task ${taskidtowaitfor} (${statusresult.status})`
                    console.log(statusresult)
                }
            }

            async function translate() {
                var sourcetexts = inputfield.value.split("\n")

                var addresponse = await fetch("/api/v1/tasks/add/", {
                    method: "POST",
                    headers: {
                        "Accept": "application/json",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        type: "translate",
                        data: {
                            targetlanguage: "de",
                            texts: sourcetexts
                        }
                    })
                })
                var addresult = await addresponse.json()
                taskidtowaitfor = addresult.id

                if (!intervalid) {
                    intervalid = setInterval(waiter, 1000)
                }
                waiter()

            }

            document.getElementById("start").addEventListener("click", translate)

        </script>
    </head>
    <body style="display:flex;flex-direction:column;">
        <textarea id="inputtext" style="display:block;" rows="10">It was not me!</textarea>
        <button id="start">Translate</button>
        <div id="result"></div>
    </body>
</html>
